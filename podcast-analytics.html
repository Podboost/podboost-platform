<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 2rem;
        }
        .insight-card {
            border-left: 4px solid #0ea5e9;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f0f9ff;
            border-radius: 0 0.375rem 0.375rem 0;
        }
        .insight-card.high {
            border-left-color: #10b981;
            background-color: #ecfdf5;
        }
        .insight-card.medium {
            border-left-color: #f59e0b;
            background-color: #fef3c7;
        }
        .insight-card.low {
            border-left-color: #ef4444;
            background-color: #fee2e2;
        }
        .sample-format {
            font-family: monospace;
            font-size: 0.9rem;
            padding: 1rem;
            background-color: #f1f5f9;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            white-space: pre;
            overflow-x: auto;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Podcast Analytics Dashboard</h1>
                    <p class="mt-1 text-sm text-gray-500">Upload your podcast analytics data to discover optimization insights</p>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Upload Your Podcast Analytics</h2>
            <p class="mb-4 text-gray-600">Upload your podcast analytics data in CSV format to analyze performance patterns and get recommendations for optimal publishing strategies.</p>
            
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Expected CSV Format:</h3>
                <div class="sample-format">episode_title,publish_date,day_of_week,publish_time,downloads,unique_listeners,completion_rate,episode_duration
"How to Grow Your Audience Fast",2023-04-15,Saturday,09:00,1250,980,0.75,45
"The Secret to Viral Episodes",2023-04-22,Saturday,10:30,2340,1820,0.82,38
"Interview with Industry Expert",2023-04-29,Saturday,08:00,1820,1435,0.79,62</div>
                <div class="mt-3 flex items-center">
                    <a href="/sample-podcast-data.csv" download class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="-ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Download Sample Data
                    </a>
                    <p class="ml-3 text-sm text-gray-600">Try the analytics tool with our sample podcast data</p>
                </div>
                <p class="mt-2 text-sm text-gray-500">Note: You can export similar data from most podcast hosting platforms or analytics tools.</p>
            </div>

            <div class="mb-6">
                <label for="data-file" class="block text-sm font-medium text-gray-700 mb-2">Upload Analytics CSV File</label>
                <input type="file" id="data-file" accept=".csv" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-md file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100
                ">
            </div>

            <div class="flex justify-end">
                <button id="analyze-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Analyze Data
                </button>
            </div>
        </div>

        <div id="loading" class="hidden bg-white rounded-lg shadow-md p-6 mb-8 text-center">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-600 mb-2"></div>
            <p class="text-gray-600">Analyzing your podcast data...</p>
        </div>

        <div id="results-container" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Performance Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="text-sm font-medium text-blue-600 mb-1">Average Downloads</p>
                        <p id="avg-downloads" class="text-3xl font-bold text-gray-900">-</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <p class="text-sm font-medium text-green-600 mb-1">Best Performing Day</p>
                        <p id="best-day" class="text-3xl font-bold text-gray-900">-</p>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <p class="text-sm font-medium text-purple-600 mb-1">Best Publishing Time</p>
                        <p id="best-time" class="text-3xl font-bold text-gray-900">-</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="downloads-chart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Day & Time Analysis</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-3">Performance by Day of Week</h3>
                        <div class="chart-container">
                            <canvas id="day-of-week-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-3">Performance by Time of Day</h3>
                        <div class="chart-container">
                            <canvas id="time-of-day-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Title Analysis</h2>
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-3">Title Length Impact</h3>
                    <div class="chart-container">
                        <canvas id="title-length-chart"></canvas>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-3">Top-Performing Title Patterns</h3>
                    <div id="title-patterns" class="space-y-4">
                        <!-- Title patterns will be inserted here -->
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Actionable Insights</h2>
                <div id="insights-container" class="space-y-4">
                    <!-- Insights will be inserted here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const analyzeBtn = document.getElementById('analyze-btn');
            const dataFileInput = document.getElementById('data-file');
            const loadingDiv = document.getElementById('loading');
            const resultsContainer = document.getElementById('results-container');
            
            // Initialize charts with empty data
            let downloadsChart, dayOfWeekChart, timeOfDayChart, titleLengthChart;
            
            analyzeBtn.addEventListener('click', function() {
                if (!dataFileInput.files.length) {
                    alert('Please select a CSV file to analyze');
                    return;
                }
                
                const file = dataFileInput.files[0];
                loadingDiv.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
                
                Papa.parse(file, {
                    header: true,
                    complete: function(results) {
                        setTimeout(() => {
                            analyzeData(results.data);
                            loadingDiv.classList.add('hidden');
                            resultsContainer.classList.remove('hidden');
                        }, 1000); // Add a slight delay to show the loading spinner
                    },
                    error: function(error) {
                        alert('Error parsing CSV file: ' + error);
                        loadingDiv.classList.add('hidden');
                    }
                });
            });
            
            function analyzeData(data) {
                // Clean and process the data
                const processedData = data.filter(row => 
                    row.episode_title && 
                    row.publish_date && 
                    row.downloads && 
                    !isNaN(parseInt(row.downloads))
                ).map(row => ({
                    ...row,
                    downloads: parseInt(row.downloads),
                    unique_listeners: parseInt(row.unique_listeners) || 0,
                    completion_rate: parseFloat(row.completion_rate) || 0,
                    episode_duration: parseInt(row.episode_duration) || 0,
                    publish_date: new Date(row.publish_date)
                })).sort((a, b) => a.publish_date - b.publish_date);
                
                if (processedData.length === 0) {
                    alert('No valid data found in the CSV file. Please check the format.');
                    return;
                }
                
                // Update overview metrics
                updateOverviewMetrics(processedData);
                
                // Create/update charts
                createCharts(processedData);
                
                // Generate title analysis
                analyzeTitles(processedData);
                
                // Generate insights
                generateInsights(processedData);
            }
            
            function updateOverviewMetrics(data) {
                // Calculate average downloads
                const avgDownloads = Math.round(data.reduce((sum, row) => sum + row.downloads, 0) / data.length);
                document.getElementById('avg-downloads').textContent = avgDownloads.toLocaleString();
                
                // Find best performing day
                const dayPerformance = {};
                data.forEach(row => {
                    if (!dayPerformance[row.day_of_week]) {
                        dayPerformance[row.day_of_week] = {
                            totalDownloads: 0,
                            count: 0
                        };
                    }
                    dayPerformance[row.day_of_week].totalDownloads += row.downloads;
                    dayPerformance[row.day_of_week].count += 1;
                });
                
                let bestDay = '';
                let bestDayAvg = 0;
                for (const day in dayPerformance) {
                    const avgForDay = dayPerformance[day].totalDownloads / dayPerformance[day].count;
                    if (avgForDay > bestDayAvg) {
                        bestDayAvg = avgForDay;
                        bestDay = day;
                    }
                }
                document.getElementById('best-day').textContent = bestDay;
                
                // Find best performing time
                const timePerformance = {};
                data.forEach(row => {
                    // Extract hour from publish_time
                    const timeMatch = row.publish_time.match(/(\d+):/);
                    if (timeMatch) {
                        const hour = parseInt(timeMatch[1]);
                        const timePeriod = hour < 12 ? 'Morning' : (hour < 17 ? 'Afternoon' : 'Evening');
                        
                        if (!timePerformance[timePeriod]) {
                            timePerformance[timePeriod] = {
                                totalDownloads: 0,
                                count: 0
                            };
                        }
                        timePerformance[timePeriod].totalDownloads += row.downloads;
                        timePerformance[timePeriod].count += 1;
                    }
                });
                
                let bestTime = '';
                let bestTimeAvg = 0;
                for (const time in timePerformance) {
                    const avgForTime = timePerformance[time].totalDownloads / timePerformance[time].count;
                    if (avgForTime > bestTimeAvg) {
                        bestTimeAvg = avgForTime;
                        bestTime = time;
                    }
                }
                document.getElementById('best-time').textContent = bestTime;
            }
            
            function createCharts(data) {
                // Downloads over time chart
                const ctx1 = document.getElementById('downloads-chart').getContext('2d');
                if (downloadsChart) downloadsChart.destroy();
                
                downloadsChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: data.map(row => {
                            const date = new Date(row.publish_date);
                            return date.toLocaleDateString();
                        }),
                        datasets: [{
                            label: 'Downloads',
                            data: data.map(row => row.downloads),
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            tension: 0.2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Episode Downloads Over Time'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                    },
                                    title: function(context) {
                                        const title = context[0].label;
                                        const index = context[0].dataIndex;
                                        return `${data[index].episode_title} (${title})`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Downloads'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Publish Date'
                                }
                            }
                        }
                    }
                });
                
                // Day of week chart
                const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const dayData = {};
                
                daysOfWeek.forEach(day => {
                    dayData[day] = {
                        totalDownloads: 0,
                        count: 0
                    };
                });
                
                data.forEach(row => {
                    if (row.day_of_week && daysOfWeek.includes(row.day_of_week)) {
                        dayData[row.day_of_week].totalDownloads += row.downloads;
                        dayData[row.day_of_week].count += 1;
                    }
                });
                
                const avgByDay = daysOfWeek.map(day => 
                    dayData[day].count > 0 ? 
                    Math.round(dayData[day].totalDownloads / dayData[day].count) : 0
                );
                
                const ctx2 = document.getElementById('day-of-week-chart').getContext('2d');
                if (dayOfWeekChart) dayOfWeekChart.destroy();
                
                dayOfWeekChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: daysOfWeek,
                        datasets: [{
                            label: 'Average Downloads',
                            data: avgByDay,
                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Average Downloads by Day of Week'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Average Downloads'
                                }
                            }
                        }
                    }
                });
                
                // Time of day chart
                const timePeriods = ['Morning (6-11am)', 'Afternoon (12-4pm)', 'Evening (5-8pm)', 'Night (9pm-5am)'];
                const timeData = {};
                
                timePeriods.forEach(period => {
                    timeData[period] = {
                        totalDownloads: 0,
                        count: 0
                    };
                });
                
                data.forEach(row => {
                    if (row.publish_time) {
                        const timeMatch = row.publish_time.match(/(\d+):/);
                        if (timeMatch) {
                            const hour = parseInt(timeMatch[1]);
                            let period;
                            
                            if (hour >= 6 && hour <= 11) {
                                period = 'Morning (6-11am)';
                            } else if (hour >= 12 && hour <= 16) {
                                period = 'Afternoon (12-4pm)';
                            } else if (hour >= 17 && hour <= 20) {
                                period = 'Evening (5-8pm)';
                            } else {
                                period = 'Night (9pm-5am)';
                            }
                            
                            timeData[period].totalDownloads += row.downloads;
                            timeData[period].count += 1;
                        }
                    }
                });
                
                const avgByTime = timePeriods.map(period => 
                    timeData[period].count > 0 ? 
                    Math.round(timeData[period].totalDownloads / timeData[period].count) : 0
                );
                
                const ctx3 = document.getElementById('time-of-day-chart').getContext('2d');
                if (timeOfDayChart) timeOfDayChart.destroy();
                
                timeOfDayChart = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: timePeriods,
                        datasets: [{
                            label: 'Average Downloads',
                            data: avgByTime,
                            backgroundColor: 'rgba(124, 58, 237, 0.6)',
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Average Downloads by Time of Day'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Average Downloads'
                                }
                            }
                        }
                    }
                });
                
                // Title length chart
                const titleLengthBuckets = {
                    'Very Short (1-3 words)': {totalDownloads: 0, count: 0},
                    'Short (4-6 words)': {totalDownloads: 0, count: 0},
                    'Medium (7-9 words)': {totalDownloads: 0, count: 0},
                    'Long (10+ words)': {totalDownloads: 0, count: 0}
                };
                
                data.forEach(row => {
                    if (row.episode_title) {
                        const wordCount = row.episode_title.split(/\s+/).length;
                        let bucket;
                        
                        if (wordCount <= 3) {
                            bucket = 'Very Short (1-3 words)';
                        } else if (wordCount <= 6) {
                            bucket = 'Short (4-6 words)';
                        } else if (wordCount <= 9) {
                            bucket = 'Medium (7-9 words)';
                        } else {
                            bucket = 'Long (10+ words)';
                        }
                        
                        titleLengthBuckets[bucket].totalDownloads += row.downloads;
                        titleLengthBuckets[bucket].count += 1;
                    }
                });
                
                const titleLengthLabels = Object.keys(titleLengthBuckets);
                const titleLengthAvgs = titleLengthLabels.map(label => 
                    titleLengthBuckets[label].count > 0 ? 
                    Math.round(titleLengthBuckets[label].totalDownloads / titleLengthBuckets[label].count) : 0
                );
                
                const ctx4 = document.getElementById('title-length-chart').getContext('2d');
                if (titleLengthChart) titleLengthChart.destroy();
                
                titleLengthChart = new Chart(ctx4, {
                    type: 'bar',
                    data: {
                        labels: titleLengthLabels,
                        datasets: [{
                            label: 'Average Downloads',
                            data: titleLengthAvgs,
                            backgroundColor: 'rgba(245, 158, 11, 0.6)',
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Impact of Title Length on Downloads'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Average Downloads'
                                }
                            }
                        }
                    }
                });
            }
            
            function analyzeTitles(data) {
                // Analyze title patterns
                const titlePatterns = {
                    'How to': {pattern: /how to/i, totalDownloads: 0, count: 0, examples: []},
                    'Numbers': {pattern: /\d+/i, totalDownloads: 0, count: 0, examples: []},
                    'Questions': {pattern: /\?/, totalDownloads: 0, count: 0, examples: []},
                    'Interview': {pattern: /interview|with/i, totalDownloads: 0, count: 0, examples: []},
                    'Tips & Secrets': {pattern: /tips|secrets|tricks|hack/i, totalDownloads: 0, count: 0, examples: []}
                };
                
                // Analyze each episode title
                data.forEach(row => {
                    if (row.episode_title) {
                        for (const key in titlePatterns) {
                            if (titlePatterns[key].pattern.test(row.episode_title)) {
                                titlePatterns[key].totalDownloads += row.downloads;
                                titlePatterns[key].count += 1;
                                titlePatterns[key].examples.push({
                                    title: row.episode_title,
                                    downloads: row.downloads
                                });
                            }
                        }
                    }
                });
                
                // Sort title patterns by average downloads
                const sortedPatterns = Object.keys(titlePatterns)
                    .map(key => ({
                        pattern: key,
                        avgDownloads: titlePatterns[key].count > 0 ? 
                            Math.round(titlePatterns[key].totalDownloads / titlePatterns[key].count) : 0,
                        count: titlePatterns[key].count,
                        examples: titlePatterns[key].examples.sort((a, b) => b.downloads - a.downloads).slice(0, 2)
                    }))
                    .filter(pattern => pattern.count > 0)
                    .sort((a, b) => b.avgDownloads - a.avgDownloads);
                
                // Display title patterns
                const patternsContainer = document.getElementById('title-patterns');
                patternsContainer.innerHTML = '';
                
                if (sortedPatterns.length > 0) {
                    sortedPatterns.forEach(pattern => {
                        const patternCard = document.createElement('div');
                        patternCard.className = 'bg-gray-50 rounded-lg p-4';
                        
                        const bestExamples = pattern.examples.map(ex => 
                            `<li class="text-gray-700"><span class="font-medium">"${ex.title}"</span> - ${ex.downloads.toLocaleString()} downloads</li>`
                        ).join('');
                        
                        patternCard.innerHTML = `
                            <div class="flex justify-between items-start">
                                <h4 class="text-lg font-medium text-gray-900">${pattern.pattern}</h4>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                                    ${pattern.avgDownloads.toLocaleString()} avg. downloads
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">Found in ${pattern.count} episode${pattern.count !== 1 ? 's' : ''}</p>
                            <div class="mt-3">
                                <p class="text-sm font-medium text-gray-700">Best performing examples:</p>
                                <ul class="mt-1 text-sm space-y-1 list-disc list-inside">
                                    ${bestExamples}
                                </ul>
                            </div>
                        `;
                        
                        patternsContainer.appendChild(patternCard);
                    });
                } else {
                    patternsContainer.innerHTML = '<p class="text-gray-500">Not enough data to analyze title patterns</p>';
                }
            }
            
            function generateInsights(data) {
                const insightsContainer = document.getElementById('insights-container');
                insightsContainer.innerHTML = '';
                
                // Generate day of week insights
                const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const dayData = {};
                
                daysOfWeek.forEach(day => {
                    dayData[day] = {
                        totalDownloads: 0,
                        count: 0
                    };
                });
                
                data.forEach(row => {
                    if (row.day_of_week && daysOfWeek.includes(row.day_of_week)) {
                        dayData[row.day_of_week].totalDownloads += row.downloads;
                        dayData[row.day_of_week].count += 1;
                    }
                });
                
                const dayAvgs = {};
                let bestDay = '';
                let bestDayAvg = 0;
                let worstDay = '';
                let worstDayAvg = Infinity;
                
                for (const day in dayData) {
                    if (dayData[day].count > 0) {
                        const avg = Math.round(dayData[day].totalDownloads / dayData[day].count);
                        dayAvgs[day] = avg;
                        
                        if (avg > bestDayAvg) {
                            bestDayAvg = avg;
                            bestDay = day;
                        }
                        
                        if (avg < worstDayAvg) {
                            worstDayAvg = avg;
                            worstDay = day;
                        }
                    }
                }
                
                if (bestDay && worstDay) {
                    const dayDiff = Math.round(((bestDayAvg - worstDayAvg) / worstDayAvg) * 100);
                    const dayInsight = document.createElement('div');
                    dayInsight.className = 'insight-card high';
                    dayInsight.innerHTML = `
                        <h3 class="text-lg font-medium text-gray-900">Optimal Publishing Day</h3>
                        <p class="text-gray-700 mt-1">Episodes published on <strong>${bestDay}</strong> perform ${dayDiff}% better than those published on ${worstDay}.</p>
                        <p class="text-gray-600 mt-2 text-sm">Recommendation: Consider shifting your publishing schedule to take advantage of ${bestDay}'s better performance.</p>
                    `;
                    insightsContainer.appendChild(dayInsight);
                }
                
                // Title pattern insights
                const titleWords = {};
                let totalTitles = 0;
                
                data.forEach(row => {
                    if (row.episode_title) {
                        totalTitles++;
                        const words = row.episode_title.toLowerCase().split(/\W+/).filter(word => word.length > 3);
                        words.forEach(word => {
                            if (!titleWords[word]) {
                                titleWords[word] = {
                                    totalDownloads: 0,
                                    count: 0
                                };
                            }
                            titleWords[word].totalDownloads += row.downloads;
                            titleWords[word].count += 1;
                        });
                    }
                });
                
                const significantWords = Object.keys(titleWords)
                    .filter(word => titleWords[word].count >= Math.max(2, Math.ceil(totalTitles * 0.1)))
                    .map(word => ({
                        word,
                        avgDownloads: Math.round(titleWords[word].totalDownloads / titleWords[word].count),
                        count: titleWords[word].count
                    }))
                    .sort((a, b) => b.avgDownloads - a.avgDownloads)
                    .slice(0, 5);
                
                if (significantWords.length > 0) {
                    const titleInsight = document.createElement('div');
                    titleInsight.className = 'insight-card medium';
                    
                    const wordsList = significantWords
                        .map(w => `<span class="font-medium">${w.word}</span> (${w.avgDownloads.toLocaleString()} avg. downloads)`)
                        .join(', ');
                    
                    titleInsight.innerHTML = `
                        <h3 class="text-lg font-medium text-gray-900">High-Performing Title Words</h3>
                        <p class="text-gray-700 mt-1">Episodes with these words in the title tend to perform better: ${wordsList}.</p>
                        <p class="text-gray-600 mt-2 text-sm">Recommendation: Consider incorporating these keywords into future episode titles when relevant.</p>
                    `;
                    insightsContainer.appendChild(titleInsight);
                }
                
                // Duration insights
                if (data.some(row => row.episode_duration)) {
                    const durationBuckets = {
                        'Short (<30 min)': {totalDownloads: 0, totalCompletion: 0, count: 0},
                        'Medium (30-60 min)': {totalDownloads: 0, totalCompletion: 0, count: 0},
                        'Long (>60 min)': {totalDownloads: 0, totalCompletion: 0, count: 0}
                    };
                    
                    data.forEach(row => {
                        if (row.episode_duration) {
                            const duration = parseInt(row.episode_duration);
                            let bucket;
                            
                            if (duration < 30) {
                                bucket = 'Short (<30 min)';
                            } else if (duration <= 60) {
                                bucket = 'Medium (30-60 min)';
                            } else {
                                bucket = 'Long (>60 min)';
                            }
                            
                            durationBuckets[bucket].totalDownloads += row.downloads;
                            if (row.completion_rate) {
                                durationBuckets[bucket].totalCompletion += parseFloat(row.completion_rate);
                            }
                            durationBuckets[bucket].count += 1;
                        }
                    });
                    
                    const durationAvgs = {};
                    const completionAvgs = {};
                    
                    for (const bucket in durationBuckets) {
                        if (durationBuckets[bucket].count > 0) {
                            durationAvgs[bucket] = Math.round(durationBuckets[bucket].totalDownloads / durationBuckets[bucket].count);
                            if (durationBuckets[bucket].totalCompletion > 0) {
                                completionAvgs[bucket] = Math.round((durationBuckets[bucket].totalCompletion / durationBuckets[bucket].count) * 100);
                            }
                        }
                    }
                    
                    // Find best performing duration
                    let bestDuration = '';
                    let bestDurationAvg = 0;
                    
                    for (const bucket in durationAvgs) {
                        if (durationAvgs[bucket] > bestDurationAvg) {
                            bestDurationAvg = durationAvgs[bucket];
                            bestDuration = bucket;
                        }
                    }
                    
                    if (bestDuration) {
                        const durationInsight = document.createElement('div');
                        durationInsight.className = 'insight-card medium';
                        
                        let completionText = '';
                        if (Object.keys(completionAvgs).length > 0) {
                            const bestCompletion = Object.entries(completionAvgs).sort((a, b) => b[1] - a[1])[0];
                            completionText = ` ${bestCompletion[0]} episodes also have the highest completion rate at ${bestCompletion[1]}%.`;
                        }
                        
                        durationInsight.innerHTML = `
                            <h3 class="text-lg font-medium text-gray-900">Optimal Episode Duration</h3>
                            <p class="text-gray-700 mt-1">${bestDuration} episodes perform best with an average of ${durationAvgs[bestDuration].toLocaleString()} downloads.${completionText}</p>
                            <p class="text-gray-600 mt-2 text-sm">Recommendation: Consider adjusting your episode length to match the ${bestDuration} format when possible.</p>
                        `;
                        insightsContainer.appendChild(durationInsight);
                    }
                }
                
                // Publishing schedule insights
                if (data.length >= 5) {
                    const pubFrequency = {};
                    
                    for (let i = 1; i < data.length; i++) {
                        const daysBetween = Math.round((data[i].publish_date - data[i-1].publish_date) / (1000 * 60 * 60 * 24));
                        const key = daysBetween <= 3 ? '1-3 days' : 
                                  daysBetween <= 7 ? '4-7 days' : 
                                  daysBetween <= 14 ? '8-14 days' : '15+ days';
                        
                        if (!pubFrequency[key]) {
                            pubFrequency[key] = {
                                totalDownloads: 0,
                                count: 0
                            };
                        }
                        
                        pubFrequency[key].totalDownloads += data[i].downloads;
                        pubFrequency[key].count += 1;
                    }
                    
                    const freqAvgs = {};
                    for (const freq in pubFrequency) {
                        if (pubFrequency[freq].count > 0) {
                            freqAvgs[freq] = Math.round(pubFrequency[freq].totalDownloads / pubFrequency[freq].count);
                        }
                    }
                    
                    // Find best frequency
                    let bestFreq = '';
                    let bestFreqAvg = 0;
                    
                    for (const freq in freqAvgs) {
                        if (freqAvgs[freq] > bestFreqAvg) {
                            bestFreqAvg = freqAvgs[freq];
                            bestFreq = freq;
                        }
                    }
                    
                    if (bestFreq) {
                        const freqInsight = document.createElement('div');
                        freqInsight.className = 'insight-card medium';
                        
                        freqInsight.innerHTML = `
                            <h3 class="text-lg font-medium text-gray-900">Optimal Publishing Frequency</h3>
                            <p class="text-gray-700 mt-1">Episodes published every ${bestFreq} perform best with an average of ${bestFreqAvg.toLocaleString()} downloads.</p>
                            <p class="text-gray-600 mt-2 text-sm">Recommendation: Consider adjusting your publishing schedule to maintain a ${bestFreq} frequency between episodes.</p>
                        `;
                        insightsContainer.appendChild(freqInsight);
                    }
                }
                
                // Trend analysis
                if (data.length >= 5) {
                    const recentTrend = data.slice(-5);
                    let increasing = true;
                    let decreasing = true;
                    
                    for (let i = 1; i < recentTrend.length; i++) {
                        if (recentTrend[i].downloads <= recentTrend[i-1].downloads) {
                            increasing = false;
                        }
                        if (recentTrend[i].downloads >= recentTrend[i-1].downloads) {
                            decreasing = false;
                        }
                    }
                    
                    // Calculate overall trend
                    const firstHalf = data.slice(0, Math.floor(data.length / 2));
                    const secondHalf = data.slice(Math.floor(data.length / 2));
                    
                    const firstHalfAvg = firstHalf.reduce((sum, row) => sum + row.downloads, 0) / firstHalf.length;
                    const secondHalfAvg = secondHalf.reduce((sum, row) => sum + row.downloads, 0) / secondHalf.length;
                    
                    const percentChange = Math.round(((secondHalfAvg - firstHalfAvg) / firstHalfAvg) * 100);
                    
                    if (Math.abs(percentChange) >= 10) {
                        const trendInsight = document.createElement('div');
                        trendInsight.className = `insight-card ${percentChange >= 0 ? 'high' : 'low'}`;
                        
                        trendInsight.innerHTML = `
                            <h3 class="text-lg font-medium text-gray-900">Long-Term Trend Analysis</h3>
                            <p class="text-gray-700 mt-1">Your podcast downloads have ${percentChange >= 0 ? 'increased' : 'decreased'} by ${Math.abs(percentChange)}% when comparing your earlier episodes to more recent ones.</p>
                            <p class="text-gray-600 mt-2 text-sm">
                                ${percentChange >= 0 ? 
                                  'Recommendation: Continue your current strategy. Consider analyzing which recent changes might have contributed to this growth.' : 
                                  'Recommendation: Review your content strategy and consider returning to approaches that worked better in earlier episodes.'}
                            </p>
                        `;
                        insightsContainer.appendChild(trendInsight);
                    }
                    
                    if (increasing || decreasing) {
                        const recentInsight = document.createElement('div');
                        recentInsight.className = `insight-card ${increasing ? 'high' : 'low'}`;
                        
                        recentInsight.innerHTML = `
                            <h3 class="text-lg font-medium text-gray-900">Recent Performance Trend</h3>
                            <p class="text-gray-700 mt-1">Your last 5 episodes show a consistent ${increasing ? 'upward' : 'downward'} trend in downloads.</p>
                            <p class="text-gray-600 mt-2 text-sm">
                                ${increasing ? 
                                  'Recommendation: Your recent changes appear to be working well. Continue this approach and consider further optimizing successful elements.' : 
                                  'Recommendation: Your recent episodes are underperforming. Consider reverting recent changes or experimenting with new approaches.'}
                            </p>
                        `;
                        insightsContainer.appendChild(recentInsight);
                    }
                }
                
                // If no insights were generated
                if (insightsContainer.children.length === 0) {
                    const noInsight = document.createElement('div');
                    noInsight.className = 'insight-card';
                    noInsight.innerHTML = `
                        <h3 class="text-lg font-medium text-gray-900">Not Enough Data</h3>
                        <p class="text-gray-700 mt-1">We need more episode data to generate meaningful insights. Try uploading a CSV with more episodes.</p>
                        <p class="text-gray-600 mt-2 text-sm">Recommendation: Continue collecting data and check back when you have at least 5-10 episodes with complete analytics.</p>
                    `;
                    insightsContainer.appendChild(noInsight);
                }
            }
        });
    </script>
</body>
</html>