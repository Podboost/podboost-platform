<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PodBoost - RSS Metadata Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            '50': '#f0f9ff',
                            '100': '#e0f2fe',
                            '200': '#bae6fd',
                            '300': '#7dd3fc',
                            '400': '#38bdf8',
                            '500': '#0ea5e9',
                            '600': '#0284c7',
                            '700': '#0369a1',
                            '800': '#075985',
                            '900': '#0c4a6e',
                            '950': '#082f49',
                        },
                    }
                }
            }
        }
    </script>
    <style>
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header/Navigation -->
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <div class="h-12 w-12 bg-primary-600 rounded-lg flex items-center justify-center mr-3">
                            <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-primary-600">PodBoost</h1>
                    </div>
                    <nav class="ml-6 flex space-x-8">
                        <a href="/" class="inline-flex items-center px-1 pt-1 text-gray-500 hover:text-primary-600">
                            Home
                        </a>
                        <a href="/analytics.html" class="inline-flex items-center px-1 pt-1 text-gray-500 hover:text-primary-600">
                            Analytics
                        </a>
                        <a href="#" class="inline-flex items-center px-1 pt-1 border-b-2 border-primary-500 text-primary-600 font-medium">
                            RSS Checker
                        </a>
                        <a href="/growth-engine.html" class="inline-flex items-center px-1 pt-1 text-gray-500 hover:text-primary-600">
                            Growth Engine
                        </a>
                        <a href="/sponsorship-finder.html" class="inline-flex items-center px-1 pt-1 text-gray-500 hover:text-primary-600">
                            Sponsor Finder
                        </a>
                        <a href="/social-media-tracker.html" class="inline-flex items-center px-1 pt-1 text-gray-500 hover:text-primary-600">
                            Social Tracker
                        </a>
                        <a href="/campaigns.html" class="inline-flex items-center px-1 pt-1 text-gray-500 hover:text-primary-600">
                            Campaigns
                        </a>
                    </nav>
                </div>
                <div class="flex items-center space-x-4" id="auth-buttons">
                    <!-- Auth buttons will be inserted here by JS -->
                    <a href="/login.html" class="text-gray-700 hover:text-primary-600 font-medium">Login</a>
                    <a href="/register.html" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700">Sign Up</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Main content -->
        <div id="main-content">
            <div class="mb-8">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Podcast RSS Metadata Optimizer</h1>
                <p class="text-lg text-gray-700">Check and optimize your podcast's RSS feed for better discoverability on all platforms</p>
            </div>

            <!-- RSS Input Form -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Analyze Your Podcast Feed</h2>
                <p class="text-gray-600 mb-6">Enter your podcast's RSS feed URL to analyze metadata and get optimization suggestions.</p>
                
                <form id="rss-form" class="space-y-4">
                    <div>
                        <label for="feed-url" class="block text-sm font-medium text-gray-700">RSS Feed URL</label>
                        <input type="url" id="feed-url" name="feed-url" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
                            placeholder="https://example.com/podcast.xml"
                            required>
                    </div>
                    
                    <div class="pt-2">
                        <button type="submit" id="analyze-btn" 
                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            Analyze RSS Feed
                        </button>
                    </div>
                </form>
            </div>

            <!-- Analysis Results (hidden until analysis completes) -->
            <div id="results-container" class="hidden space-y-8">
                <!-- Loading indicator (shown while analyzing) -->
                <div id="analyzing-indicator" class="bg-white rounded-lg shadow-md p-6 text-center hidden">
                    <div class="animate-spin inline-block rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mb-4"></div>
                    <p class="text-lg text-gray-700">Analyzing your podcast RSS feed...</p>
                </div>

                <!-- Error indicator -->
                <div id="error-container" class="hidden"></div>

                <!-- Podcast Overview -->
                <div id="podcast-overview" class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Podcast Overview</h2>
                    <div class="space-y-4">
                        <div id="podcast-header" class="flex items-start space-x-4">
                            <div id="podcast-image-container" class="w-32 h-32 bg-gray-200 rounded-lg flex-shrink-0 overflow-hidden">
                                <img id="podcast-image" src="" alt="Podcast Artwork" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1">
                                <h3 id="podcast-title" class="text-xl font-bold text-gray-900"></h3>
                                <p id="podcast-author" class="text-gray-600"></p>
                                <div id="podcast-categories" class="mt-2 flex flex-wrap gap-2"></div>
                            </div>
                            <!-- SEO Score -->
                            <div class="bg-gray-100 rounded-lg p-4 w-40 text-center">
                                <p class="text-sm text-gray-600 font-medium mb-1">SEO Score</p>
                                <div class="relative pt-1">
                                    <div class="overflow-hidden h-2 text-xs flex rounded bg-gray-200">
                                        <div id="seo-score-bar" class="progress-bar-fill shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-primary-500" style="width: 0%"></div>
                                    </div>
                                </div>
                                <p id="seo-score-value" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-1">Description</h4>
                            <p id="podcast-description" class="text-gray-600 text-sm"></p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-2">
                            <div>
                                <h4 class="text-sm font-medium text-gray-700">Language</h4>
                                <p id="podcast-language" class="text-gray-900"></p>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-gray-700">Owner</h4>
                                <p id="podcast-owner" class="text-gray-900"></p>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-gray-700">Episodes</h4>
                                <p id="podcast-episode-count" class="text-gray-900"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Issues and Recommendations -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Validation Issues -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">Feed Validation</h2>
                        <div id="validation-container" class="space-y-4">
                            <!-- Validation issues will be inserted here -->
                        </div>
                        <div id="no-validation-issues" class="hidden">
                            <p class="text-green-600 font-medium">No validation issues found! 🎉</p>
                        </div>
                    </div>

                    <!-- Optimization Suggestions -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">Optimization Suggestions</h2>
                        <div id="optimization-container" class="space-y-4">
                            <!-- Optimization suggestions will be inserted here -->
                        </div>
                        <div id="no-optimization-issues" class="hidden">
                            <p class="text-green-600 font-medium">Your podcast is fully optimized! 🚀</p>
                        </div>
                    </div>
                </div>

                <!-- Episodes -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Recent Episodes</h2>
                    <div id="episodes-container" class="space-y-6">
                        <!-- Episodes will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t mt-16">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-gray-500 text-sm">
                &copy; 2025 PodBoost. All rights reserved.
            </p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const rssForm = document.getElementById('rss-form');
            const analyzingIndicator = document.getElementById('analyzing-indicator');
            const resultsContainer = document.getElementById('results-container');
            const errorContainer = document.getElementById('error-container');
            
            // RSS form submit handler
            rssForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const feedUrl = document.getElementById('feed-url').value.trim();
                if (!feedUrl) return;
                
                try {
                    // Show analyzing indicator and results container
                    analyzingIndicator.classList.remove('hidden');
                    resultsContainer.classList.remove('hidden');
                    errorContainer.classList.add('hidden');
                    
                    // Hide podcast overview until we have data
                    document.getElementById('podcast-overview').style.display = 'none';
                    
                    // Clear previous results
                    document.getElementById('podcast-title').textContent = '';
                    document.getElementById('podcast-author').textContent = '';
                    document.getElementById('podcast-description').textContent = '';
                    document.getElementById('podcast-image').src = '';
                    document.getElementById('podcast-categories').innerHTML = '';
                    document.getElementById('podcast-language').textContent = '';
                    document.getElementById('podcast-owner').textContent = '';
                    document.getElementById('podcast-episode-count').textContent = '';
                    document.getElementById('seo-score-value').textContent = '-';
                    document.getElementById('seo-score-bar').style.width = '0%';
                    document.getElementById('validation-container').innerHTML = '';
                    document.getElementById('optimization-container').innerHTML = '';
                    document.getElementById('episodes-container').innerHTML = '';
                    
                    // Get auth token if it exists
                    const authToken = localStorage.getItem('auth_token');
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    if (authToken) {
                        headers['Authorization'] = `Bearer ${authToken}`;
                    }
                    
                    // Send request to API
                    const response = await fetch('/api/rss/check-rss', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            rss_url: feedUrl
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${await response.text()}`);
                    }
                    
                    const data = await response.json();
                    console.log('API response:', data);
                    
                    // Hide analyzing indicator
                    analyzingIndicator.classList.add('hidden');
                    
                    // Show podcast overview
                    document.getElementById('podcast-overview').style.display = 'block';
                    
                    // Display podcast metadata
                    document.getElementById('podcast-title').textContent = data.podcast_metadata.title || 'Untitled Podcast';
                    document.getElementById('podcast-author').textContent = data.podcast_metadata.author || 'Unknown Author';
                    document.getElementById('podcast-description').textContent = data.podcast_metadata.description || 'No description available';
                    
                    // Set image if available
                    if (data.podcast_metadata.image) {
                        document.getElementById('podcast-image').src = data.podcast_metadata.image;
                    }
                    
                    // Display categories as tags
                    const categoriesContainer = document.getElementById('podcast-categories');
                    categoriesContainer.innerHTML = '';
                    if (data.podcast_metadata.categories && data.podcast_metadata.categories.length > 0) {
                        data.podcast_metadata.categories.forEach(category => {
                            const tag = document.createElement('span');
                            tag.className = 'px-2 py-1 text-xs font-medium bg-primary-100 text-primary-800 rounded-full';
                            tag.textContent = category;
                            categoriesContainer.appendChild(tag);
                        });
                    }
                    
                    // Display other metadata
                    document.getElementById('podcast-language').textContent = data.podcast_metadata.language || 'Not specified';
                    
                    const ownerText = data.podcast_metadata.owner_name
                        ? `${data.podcast_metadata.owner_name}${data.podcast_metadata.owner_email ? ` (${data.podcast_metadata.owner_email})` : ''}`
                        : (data.podcast_metadata.owner_email || 'Not specified');
                    document.getElementById('podcast-owner').textContent = ownerText;
                    
                    document.getElementById('podcast-episode-count').textContent = data.episode_count || '0';
                    
                    // Calculate and display SEO score
                    let seoScore = data.seo_score || 0;
                    if (!seoScore && data.validation_score) {
                        seoScore = data.validation_score;
                    }
                    
                    document.getElementById('seo-score-value').textContent = seoScore;
                    document.getElementById('seo-score-bar').style.width = `${seoScore}%`;
                    
                    // Set color based on score
                    const scoreBar = document.getElementById('seo-score-bar');
                    if (seoScore < 50) {
                        scoreBar.classList.remove('bg-primary-500', 'bg-green-500');
                        scoreBar.classList.add('bg-red-500');
                    } else if (seoScore < 80) {
                        scoreBar.classList.remove('bg-green-500', 'bg-red-500');
                        scoreBar.classList.add('bg-primary-500');
                    } else {
                        scoreBar.classList.remove('bg-primary-500', 'bg-red-500');
                        scoreBar.classList.add('bg-green-500');
                    }
                    
                    // Display validation issues
                    const validationContainer = document.getElementById('validation-container');
                    const noValidationIssues = document.getElementById('no-validation-issues');
                    
                    validationContainer.innerHTML = '';
                    
                    if (data.feed_validation && data.feed_validation.length > 0) {
                        noValidationIssues.classList.add('hidden');
                        
                        // Group by severity
                        const errorIssues = data.feed_validation.filter(issue => issue.severity === 'error');
                        const warningIssues = data.feed_validation.filter(issue => issue.severity === 'warning');
                        const infoIssues = data.feed_validation.filter(issue => issue.severity === 'info');
                        
                        // Display errors first
                        errorIssues.forEach(issue => {
                            validationContainer.appendChild(createIssueElement(issue, 'bg-red-50', 'text-red-800', 'border-red-200'));
                        });
                        
                        // Then warnings
                        warningIssues.forEach(issue => {
                            validationContainer.appendChild(createIssueElement(issue, 'bg-yellow-50', 'text-yellow-800', 'border-yellow-200'));
                        });
                        
                        // Then info
                        infoIssues.forEach(issue => {
                            validationContainer.appendChild(createIssueElement(issue, 'bg-blue-50', 'text-blue-800', 'border-blue-200'));
                        });
                    } else {
                        noValidationIssues.classList.remove('hidden');
                    }
                    
                    // Display optimization suggestions
                    const optimizationContainer = document.getElementById('optimization-container');
                    const noOptimizationIssues = document.getElementById('no-optimization-issues');
                    
                    optimizationContainer.innerHTML = '';
                    
                    if (data.optimization_suggestions && data.optimization_suggestions.length > 0) {
                        noOptimizationIssues.classList.add('hidden');
                        
                        data.optimization_suggestions.forEach(suggestion => {
                            optimizationContainer.appendChild(createSuggestionElement(suggestion));
                        });
                    } else {
                        noOptimizationIssues.classList.remove('hidden');
                    }
                    
                    // Display episodes
                    const episodesContainer = document.getElementById('episodes-container');
                    episodesContainer.innerHTML = '';
                    
                    if (data.recent_episodes && data.recent_episodes.length > 0) {
                        // Episodes are already sorted by the API (most recent first)
                        // Display up to 5 most recent episodes
                        data.recent_episodes.slice(0, 5).forEach(episode => {
                            episodesContainer.appendChild(createEpisodeElement(episode));
                        });
                    } else {
                        episodesContainer.innerHTML = '<p class="text-gray-500">No episodes found in the feed</p>';
                    }
                    
                } catch (error) {
                    console.error('Error analyzing feed:', error);
                    
                    // Hide analyzing indicator
                    analyzingIndicator.classList.add('hidden');
                    
                    // Show error message
                    errorContainer.classList.remove('hidden');
                    errorContainer.innerHTML = `
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-8">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800">Error analyzing RSS feed</h3>
                                    <div class="mt-2 text-sm text-red-700">
                                        <p>${error.message || 'An error occurred while analyzing the feed.'}</p>
                                    </div>
                                    <div class="mt-4">
                                        <button type="button" id="dismiss-error-btn" class="text-sm font-medium text-red-800 hover:text-red-900">
                                            Try again
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add event listener to dismiss button
                    document.getElementById('dismiss-error-btn').addEventListener('click', function() {
                        errorContainer.classList.add('hidden');
                        resultsContainer.classList.add('hidden');
                    });
                }
            });
            
            // Helper function to create issue element
            function createIssueElement(issue, bgClass, textClass, borderClass) {
                const element = document.createElement('div');
                element.className = `${bgClass} border-l-4 ${borderClass} p-4`;
                element.innerHTML = `
                    <div class="flex">
                        <div class="ml-3">
                            <p class="text-sm ${textClass} font-medium">${issue.message}</p>
                            ${issue.location ? `<p class="mt-1 text-xs ${textClass}">Location: ${issue.location}</p>` : ''}
                        </div>
                    </div>
                `;
                return element;
            }
            
            // Helper function to create suggestion element
            function createSuggestionElement(suggestion) {
                const element = document.createElement('div');
                element.className = 'bg-primary-50 border-l-4 border-primary-200 p-4';
                element.innerHTML = `
                    <div class="flex">
                        <div class="ml-3">
                            <p class="text-sm text-primary-800 font-medium">${suggestion.title || suggestion.message}</p>
                            <p class="mt-1 text-xs text-primary-700">${suggestion.description || ''}</p>
                            ${suggestion.recommendation ? `<p class="mt-2 text-xs text-primary-900 font-medium">Recommendation: ${suggestion.recommendation}</p>` : ''}
                        </div>
                    </div>
                `;
                return element;
            }
            
            // Helper function to create episode element
            function createEpisodeElement(episode) {
                const pubDate = episode.publish_date ? new Date(episode.publish_date).toLocaleDateString() : 'Unknown date';
                const duration = episode.duration || 'Unknown';
                
                const element = document.createElement('div');
                element.className = 'p-4 border rounded-lg';
                element.innerHTML = `
                    <h3 class="text-lg font-medium text-gray-900">${episode.title}</h3>
                    <p class="text-sm text-gray-500">${pubDate} • ${duration}</p>
                    <p class="mt-2 text-sm text-gray-600 line-clamp-2">${episode.description || 'No description'}</p>
                    ${episode.enclosure_url ? `
                    <div class="mt-3">
                        <a href="${episode.enclosure_url}" target="_blank" class="text-primary-600 text-sm font-medium hover:text-primary-500">
                            Listen to episode
                        </a>
                    </div>
                    ` : ''}
                `;
                return element;
            }
            
            // Format duration in seconds to hh:mm:ss or mm:ss
            function formatDuration(seconds) {
                if (!seconds) return 'Unknown';
                
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;
                
                if (hours > 0) {
                    return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                } else {
                    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                }
            }
        });

        // Helper auth functions - gets the auth token from localStorage
        function getAuthToken() {
            return localStorage.getItem('auth_token');
        }

        // Logout function
        function logout() {
            localStorage.removeItem('auth_token');
            window.location.href = '/login.html';
        }

        // Get current user from API
        async function getCurrentUser() {
            const token = getAuthToken();
            if (!token) {
                console.log('Not logged in (no token)');
                return null;
            }
            
            try {
                console.log('Attempting to get current user');
                const response = await fetch('/api/users/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('Auth token expired or invalid');
                        localStorage.removeItem('auth_token');
                        return null;
                    }
                    throw new Error(`Error ${response.status}: ${await response.text()}`);
                }
                
                const user = await response.json();
                console.log('User data retrieved:', user);
                return user;
            } catch (error) {
                console.error('Error getting user:', error);
                return null;
            }
        }
    </script>

    <!-- Footer -->
    <footer class="bg-white mt-12 py-8 border-t border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <p class="text-center text-gray-500 text-sm">
                &copy; 2025 PodBoost. All rights reserved.
            </p>
            <p class="mt-2 text-center text-sm text-primary-600">
                <a href="https://podshape.com/" target="_blank" class="hover:text-primary-800">A Podshape company</a>
            </p>
        </div>
    </footer>
</body>
</html>